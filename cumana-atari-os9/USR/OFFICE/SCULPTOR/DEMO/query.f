SCULPTOR ENQUIRY SYSTEM. query.f. 7 Aug 1986. Release 1.14:5!file des descript!file query!temp date,Date,d4!temp ttyno,,i2,!temp repnam,,a8,"+ rep0000"!temp t_s,Type,a4!temp t_name,,a12!temp not_found,,i1!temp dummy,,a0!temp scrline,,i1!temp tstat,,i2!temp f_flag1, ,a1!temp f_flag2, ,a1!temp f_flag3, ,a1!temp select,,a2!temp t_klen,,i1!temp n_main,,i1!temp t_i1,,i1!temp t_i2,,i2!temp t_a3,,a3!temp t_a30,,a30!temp t_m4,,m4!temp t_m8,,m8!temp t_i4,,i4!temp t_d4,,d4!temp t_r8,,r8!temp flag,,i1. 0 = ok, 1 = blank, 2 = backspace, 3 = start again!temp op_string,,a30!temp op_msg,,a45!temp fc_msg,,a60!temp sel_msg,,a40!temp con_msg,,a30!temp mon_msg,,a44!temp crit_msg,,a50!temp num1,Num.,i1!temp head1,Heading,a27!temp type1,Type,a4!temp num2,Num.,i1!temp head2,Heading,a27!temp type2,Type,a4!temp d_count,,i1!temp am_flag,,i1!temp done,,i1!temp xn_save,,a12!temp printer,Printer Device,a10+r_name,Enquiry name,2,15+rh_title,,2,49+rh_main,Main file name,3,23+rx_xname,Cross reference file,4,23+rx_klen,Key length,4,76+rx_keys,Cross-reference selection,9,29+rp_plist,,10,14+cond1,,6,17+op1,,6,40+f_flag1,,6,45+val1,,6,49+cond2,,7,17+op2,,7,40+f_flag2,,7,45+val2,,7,49+cond3,,8,17+op3,,8,40+f_flag3,,8,45+val3,,8,49+select,"Select field (? = list available fields, s = start selection again)",5,77!scroll 11,9+num1,,11,2,##+head1,,11,6+type1,,11,35+num2,,11,41+head2,,11,46+type2,,11,75+dummy, ,21,3+printer,,21,50	cancel off	repnam = ttyno	am_flag = 0	op_string = "= ,<>,> ,< ,>=,<=,bw,ct,"	crit_msg = "Enter selection conditions - select a field first"	op_msg = "Operator: =, <>, >, <, >=, <=, bw, ct"	fc_msg = "If the comparison is with another field enter 'f' here"	sel_msg = "Select the field for comparison"	con_msg = "Enter a constant value"	mon_msg = "Enter money constant in lower currency unit"BEGIN\	clearn0\	n_main = 0	message "Type the name for this enquiry (BACKSPACE to exit)"n1\	input r_name bs = EXIT. is there one with this name already ?	testkey query nsr = n2	gosub disp_enqo1\	prompt "Do you wish to amend this enquiry" no = o11	am_flag = 1	gosub COLLECT	am_flag = 0	if done then write query	gosub disp_enqo11\	prompt "Do you wish to run this enquiry" no = o2	gosub run	goto BEGINo2\ prompt "Do you wish to delete this enquiry format from the enquiry file"\	 no = o3	delete queryo3\	goto BEGINn2\	prompt "Is this a new enquiry type" yes = n20	message "It is not in the enquiry file - try again"	goto n1n20\	gosub COLLECT	if done then\	 insert query: \	 read query : goto o11	goto n0ABORT\	returnCOLLECT\	done = 0	message "Enter the main file name (leave out the '.d')"n21\	input rh_main bs = ABORT	clear dummy	de_file = rh_main	gosub check_des	if not_found then goto n21	n_main = t_i1n4\	message "Type a page title heading"	input rh_title bs = COLLECTn5\	rh_xrefs = 0	message "Type a cross_reference file name, or leave blank"n51\	xn_save = rx_xname	input rx_xname bs = n4	if rx_xname = "" then clear rx_keys:goto n8	if rx_xname = rh_main then\	 error "Cross reference file cannot be the same as the main file":\	 goto n51	if am_flag and rx_keys <> "" and (rx_xname = xn_save) then\	 rh_xrefs = 1:\	 prompt "Do you wish to change the cross-reference key" no = n8	de_file = rx_xname	gosub check_des	if not_found then goto n51	clear dummy	rx_klen = 0. Descriptor exists - see check_des above	find des key = de_filen6_loop\	if de_rectype <> "k" then goto n6_end	rx_klen = rx_klen + de_fsize	match des nsr = n6_end: goto n6_loopn6_end\	display rx_klen message "Select field(s) for cross-reference file matching"n6\	t_klen = 0	clear rx_keyssel_loop\	gosub get_sel	if flag = 1 then\	 goto sel_end	if flag = 2 then\	 goto n5	if flag = 3 then\	 t_klen = 0: \	 clear rx_keys:\	 message "Start selection of fields for cross-ref. key again":\	 goto sel_loop	t_klen = t_klen + de_fsize	if rx_keys <> "" then rx_keys = rx_keys / ","	rx_keys = rx_keys / de_field	display rx_keys	if t_klen > rx_klen then\	 error "The selected fields are too long to match the cross-ref. key":\	 goto sel_loop	if t_klen <> rx_klen then goto sel_loopsel_end\	if t_klen <> rx_klen then\	 error "The selected fields do not match the cross_ref. key length":\	 goto sel_loop	rh_xrefs = 1n8\	if am_flag then\	 prompt "Do you wish to change the print list" no = psel_end	message "Select fields for printing"n9\	rp_tlist = ""	rp_plist = ""	display rp_plistpsel_loop\	gosub get_sel	if flag = 1 then\	 goto psel_end	if flag = 2 then\	 goto n5	if flag = 3 then\	 message "Start selection of fields for printing":\	 goto n9	if rp_plist <> "" then rp_plist = rp_plist / ","	rp_plist = rp_plist / de_field	display rp_plist	if "ad" ct de_ftype then goto psel_loop	if rp_tlist <> "" then rp_tlist = rp_tlist / ","	rp_tlist = rp_tlist / de_field	goto psel_looppsel_end\	if rp_plist = "" then\	 prompt "Are you sure you want to print nothing" no = n8	if rp_tlist <> "" then\	 prompt "Do you want totals shown" yes = cond_start	rp_tlist = ""cond_start\	if am_flag then\	 prompt "Do you wish to change the selection criteria" no = cond_endconditions\	message "Enter selection conditions - select a field first"	clear cond1-val3	gosub get_sel	if flag = 1 then goto cond_end	if flag = 2 then goto n8	if flag = 3 then goto conditions	cond1 = de_field	display cond1	message op_msgcond_1\	input op1 bs = conditions	if op1 = "" then goto cond_1	t_a3 = op1 + ","	gosub check_op	if flag then goto cond_1cond_10\	f_flag1 = "c"	display f_flag1	message fc_msg	input f_flag1 bs = conditions	if "cf" ct f_flag1 then goto cond_11	error "":goto cond_10cond_11\	if f_flag1 = 'c' then goto cond_12	message sel_msg	gosub get_sel	if (flag = 1) or (flag = 3) then goto cond_11	if flag = 2 then goto cond_10	val1 = de_field	goto cond_14cond_12\	if de_ftype = 'm' then message mon_msg else message con_msgcond_13\	input val1 bs = cond_1	t_a30 = val1	gosub check_val	if flag then goto cond_13	val1 = t_a30cond_14\	display val1cond_20\	message crit_msg	clear cond2-val2	gosub get_sel	if flag = 1 then goto cond_end	if flag = 2 then goto conditions	if flag = 3 then goto cond_20	cond2 = de_field	display cond2	message op_msgcond_2\	input op2 bs = cond_20	if op2 = "" then goto cond_2	t_a3 = op2 + ","	gosub check_op	if flag then goto cond_2cond_201\	f_flag2 = "c"	display f_flag2	message fc_msg	input f_flag2 bs = cond_20	if "cf" ct f_flag2 then goto cond_21	error "":goto cond_201cond_21\	if f_flag2 = 'c' then goto cond_22	message sel_msg	gosub get_sel	if (flag = 1) or (flag = 3) then goto cond_21	if flag = 2 then goto cond_201	val2 = de_field	goto cond_24cond_22\	if de_ftype = 'm' then message mon_msg else message con_msgcond_23\	input val2 bs = cond_2	t_a30 = val2	gosub check_val	if flag then goto cond_23	val2 = t_a30cond_24\	display val2cond_30\	message crit_msg	clear cond3-val3	gosub get_sel	if flag = 1 then goto cond_end	if flag = 2 then goto cond_20	if flag = 3 then goto cond_30	cond3 = de_field	display cond3	message op_msgcond_3\	input op3 bs = cond_30	if op3 = "" then goto cond_3	t_a3 = op3 + ","	gosub check_op	if flag then goto cond_3cond_301\	f_flag3 = "c"	display f_flag3	message fc_msg	input f_flag3 bs = cond_30	if "cf" ct f_flag3 then goto cond_31	error "":goto cond_301cond_31\	if f_flag3 = 'c' then goto cond_32	message sel_msg	gosub get_sel	if (flag = 1) or (flag = 3) then goto cond_31	if flag = 2 then goto cond_301	val3 = de_field	goto cond_34cond_32\	if de_ftype = 'm' then message mon_msg else message con_msgcond_33\	input val3 bs = cond_3	t_a30 = val3	gosub check_val	if flag then goto cond_33	val3 = t_a30cond_34\	display val3cond_end\	done = 1	returndisp_enq\	t_a30 = r_name	clear	r_name = t_a30	read query nsr = no_query	display r_name-val3	returnno_query\	error "Can't read record for " + r_name	endrun\	message "If the Printer Device name is blank, the screen will be used"	input printer	message "Please wait a moment..."	unlock query	execu '-rgen ' + r_name + repnam	if tstat then sleep 3: goto run_all	if printer = "" then goto run_screen. printer	execu 'sagerep ' + repnam + ' >/' + printer	if tstat then sleep 3	goto run_allrun_screen\	exec 'sagerep ' + repnam + ' pvdu; pause'	if tstat then sleep 3run_all\	newform	goto BEGIN**e=exitEXIT\	exit. Get a field number from the user and process.. Sel_flag value on return:. 0 good field found. 1 blank box entry. 2 back-space typed. 3 's' typed (start again)get_sel\	flag = 0	clear selectget_sel0\	input select bs = get_sel1 : goto get_sel3get_sel1\	flag = 2: returnget_sel3\	if select = "" then\	 flag = 1: return	if select = "?" then\	 gosub disp_fields:\	 goto get_sel	if select = "s" then\	 flag = 3: return	de_fnum = select	if de_fnum = 0 then\	 error "Bad field number":\	 goto get_sel0	de_file = rh_main	if de_fnum > n_main and rh_xrefs then\	 de_fnum = de_fnum - n_main:\	 de_file = rx_xname	read des nsr = get_sel4 : returnget_sel4\	error "No such field number"	goto get_sel0check_des\	de_fnum = 1	not_found = 0	testkey des nsr = chd1:goto chd2chd1\	message "Fetching descriptor for " + de_file	display dummy	close des	execu "-putdesc descript " + de_file	open des	if tstat <> 0 then\	 error "Cannot find or load a SCULPTOR file of that name":\	 not_found = 1 : return. Now count the fieldschd2\	t_i1 = 1chd_loop\	de_fnum = de_fnum + 1	testkey des nsr = chd_end	t_i1 = t_i1 + 1	goto chd_loopchd_end\	de_fnum = 1	returndisp_fields\	scroll 1	d_count = 0	de_file = rh_main	gosub disp1. If user wants out - return	if t_i1 then return	if rh_xrefs then\	 de_file = rx_xname:\	 gosub disp1disp_f1 \	if (d_count = 0) or (d_count = 18) then return	if d_count < 9 then\	 clear num1-type1: goto disp_f2. else	 clear num2-type2disp_f2\	d_count = d_count + 1	scroll	goto disp_f1disp1\	t_i1 = 0	de_fnum = 0gdloop\	de_fnum = de_fnum + 1	read des nsr = gdloop_end	if d_count = 18 then\	 d_count = 0:\	 prompt "Do you wish to see further" yes = disp2:\	 t_i1 = 1: returndisp2\	d_count = d_count + 1	t_s = de_fsize	t_s = de_ftype + t_s	if de_heading = "" then\	 de_heading = de_field	if d_count <= 9 then\	 num1 = scrline : head1 = de_heading : type1 = t_s:\	 display num1-type1:\	 goto disp3. else	 num2 = scrline : head2 = de_heading : type2 = t_s	 display num2-type2disp3\	scroll	goto gdloopgdloop_end\	returncheck_val\	flag = 0	if de_ftype = 'a' then goto check_a	if de_ftype = 'd' then goto check_d	if de_ftype = 'i' then goto check_i	if de_ftype = 'm' then goto check_m. must be real	t_r8 = t_a30	if t_r8 = 0 and t_a30 <> '0' then\	 error "Not a valid real number format":\	 flag = 1	returncheck_m\	if de_fsize = 8 then goto check_m8	t_m4 = t_a30	if (t_m4 = 0 and t_a30 <> '0') or t_a30 ct '.' then goto bad_money	returncheck_m8\	t_m8 = t_a30	if (t_m8 = 0 and t_a30 <> '0') or t_a30 ct '.' then goto bad_money	returnbad_money\	error "Not a valid money format"	flag = 1	returncheck_d\	t_d4 = t_a30	if t_a30 = '0' then return	if t_d4 = 0 then\	 error "Not a valid date":\	 flag = 1:return	if t_a30 ct ',' then return	error \"The day, month and year of a date must be separated by commas e.g. 10,1,85"	flag = 1	returncheck_i\	t_i4 = t_a30	if (t_i4 = 0 and t_a30 <> '0') or (t_a30 ct '.') then\	 error "Not an integer":\	 flag = 1	returncheck_a\	if (t_a30 bw '"') or (t_a30 bw "'") then return	t_a30 = '"' / t_a30 / '"'	returncheck_op\	flag = 0	if (de_ftype <> 'a') and ("bw,ct," ct t_a3) then\	 error "Inapproriate operator":\	 flag = 1:return	if op_string ct t_a3 then return	error ""	flag = 1	return